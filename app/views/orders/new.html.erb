<h1>Checkout</h1>

<%= form_with model: @order, local: true, id: 'order_form' do |form| %>
  <div class="mb-3">
    <%= form.label :recipient_name, "Recipient Name", class: 'form-label' %>
    <%= form.text_field :recipient_name, value: current_user.username, class: 'form-control' %>
  </div>
  <div class="mb-3">
    <%= form.label :recipient_address, "Recipient Address", class: 'form-label' %>
    <%= form.text_field :recipient_address, value: current_user.address, class: 'form-control' %>
  </div>
  <div class="mb-3">
    <%= form.label :province, class: 'form-label' %>
    <%= form.collection_select :province_id, Province.all, :id, :name, selected: current_user.province_id, id: 'order_province_id', class: 'form-select' %>
  </div>
  <div class="mb-3">
    <%= form.label :total_amount, class: 'form-label' %>
    <%= form.number_field :total_amount, value: @order.total_amount, readonly: true, id: "order_total_amount", class: 'form-control' %>
  </div>
  <div class="d-grid gap-2">
    <%= form.submit 'Place Order', class: 'btn btn-success' %>
    <button type="button" class="btn btn-primary" onclick="updateTotal()">Update Total</button>
  </div>
<% end %>

<script>
  function updateTotal() {
    const provinceId = document.querySelector('#order_province_id').value;

    fetch('/orders/recalculate_total', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      },
      body: JSON.stringify({ province_id: provinceId })
    })
    .then(response => response.json())
    .then(data => {
      document.querySelector('#order_total_amount').value = data.total_amount;
    })
    .catch(error => console.error('Error:', error));
  }
</script>
